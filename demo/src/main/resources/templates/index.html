<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>URL Shortener</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>

<div class="container mt-5">
    <h2 class="text-center mb-4">URL Shortener</h2>

    <form th:action="@{/}" method="post">
        <div class="mb-3">
            <input type="url" name="url" class="form-control" placeholder="Enter your long URL" required />
        </div>

        <div class="mb-3">
            <label for="customCode" class="form-label">Custom Code (optional)</label>
            <input type="text" id="customCode" name="customCode" class="form-control" placeholder="4-10 alphanumeric chars" pattern="[A-Za-z0-9]{4,10}" title="4-10 alphanumeric characters" />
        </div>

        <div class="mb-3">
            <label for="expiry" class="form-label">Expiry Date (optional)</label>
            <input type="datetime-local" id="expiry" name="expiry" class="form-control" />
        </div>

        <!-- Honeypot field to trap bots; real users won't fill this -->
        <input type="text" name="honeypot" style="display:none" autocomplete="off" tabindex="-1"/>

        <button type="submit" class="btn btn-primary w-100">Shorten URL</button>
    </form>

    <div th:if="${shortLink != null}" class="alert alert-success mt-3">
        <h5>Your Shortened URL:</h5>
        <a th:href="@{/u/{code}(code=${shortLink.shortCode})}" th:text="@{/u/{code}(code=${shortLink.shortCode})}" target="_blank"></a>
        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="navigator.clipboard.writeText(this.previousElementSibling.textContent).then(() => alert('Copied!'))">
            Copy
        </button>
        <div th:if="${shortLink.expiryDate != null}" class="mt-2">
            <small>Expires on: <span th:text="${#temporals.format(shortLink.expiryDate, 'yyyy-MM-dd HH:mm')}"></span></small>
        </div>
    </div>

    <div th:if="${errorMessage != null}" class="alert alert-danger mt-3" th:text="${errorMessage}"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Copy button functionality
    document.querySelectorAll('button').forEach(button => {
      button.addEventListener('click', function() {
        const urlText = this.previousElementSibling.textContent;
        navigator.clipboard.writeText(urlText).then(() => {
          alert('Short URL copied to clipboard!');
        });
      });
    });

    // Basic client-side validation for custom code pattern
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
      const customCodeInput = document.querySelector('input[name="customCode"]');
      if (customCodeInput.value && !/^[A-Za-z0-9]{4,10}$/.test(customCodeInput.value)) {
        event.preventDefault();
        alert('Custom code must be 4 to 10 alphanumeric characters.');
        customCodeInput.focus();
        return false;
      }
    });
  });
</script>

</body>
</html>
